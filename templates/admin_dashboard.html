{% extends "base.html" %}

{% block title %}Dashboard Admin - HyperLiquid SaaS{% endblock %}

{% block content %}
<div class="card">
    <div class="header">
        <div class="logo">üë®‚Äçüíº Dashboard Admin</div>
        <div class="subtitle">Gestion des utilisateurs et bots</div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
        <div style="background: #f0fff4; padding: 20px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2em; color: #22543d;">{{ users|selectattr('is_active')|list|length }}</div>
            <div style="color: #22543d; font-weight: 600;">Utilisateurs Actifs</div>
        </div>
        
        <div style="background: #fef5e7; padding: 20px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2em; color: #744210;">{{ users|rejectattr('is_active')|list|length }}</div>
            <div style="color: #744210; font-weight: 600;">En Attente</div>
        </div>
        
        <div style="background: #e6fffa; padding: 20px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2em; color: #234e52;">{{ users|selectattr('signum_connected')|list|length }}</div>
            <div style="color: #234e52; font-weight: 600;">Connect√©s Signum</div>
        </div>
        
        <div style="background: #edf2f7; padding: 20px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2em; color: #4a5568;">{{ users|list|length }}</div>
            <div style="color: #4a5568; font-weight: 600;">Total Inscrits</div>
        </div>
    </div>
    
    <h2 style="margin: 40px 0 20px 0; color: #2d3748;">Gestion des Utilisateurs</h2>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <thead style="background: #f7fafc;">
                <tr>
                    <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0;">Nom</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0;">Email</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0;">Wallet</th>
                    <th style="padding: 15px; text-align: center; border-bottom: 1px solid #e2e8f0;">Statut</th>
                    <th style="padding: 15px; text-align: center; border-bottom: 1px solid #e2e8f0;">Inscription</th>
                    <th style="padding: 15px; text-align: center; border-bottom: 1px solid #e2e8f0;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 15px;">{{ user.name }}</td>
                    <td style="padding: 15px; color: #718096;">{{ user.email }}</td>
                    <td style="padding: 15px; font-family: monospace; font-size: 0.9em;">{{ user.wallet_address[:10] }}...</td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="margin-bottom: 5px;">
                            {% if user.is_active %}
                            <span style="background: #c6f6d5; color: #22543d; padding: 3px 8px; border-radius: 15px; font-size: 0.8em; font-weight: 600;">‚úÖ Actif</span>
                            {% else %}
                            <span style="background: #fed7d7; color: #742a2a; padding: 3px 8px; border-radius: 15px; font-size: 0.8em; font-weight: 600;">‚è≥ En attente</span>
                            {% endif %}
                        </div>
                        <div>
                            {% if user.signum_connected %}
                            <span style="background: #bee3f8; color: #2c5282; padding: 3px 8px; border-radius: 15px; font-size: 0.8em; font-weight: 600;">üîó Signum OK</span>
                            {% else %}
                            <span style="background: #fbb6ce; color: #97266d; padding: 3px 8px; border-radius: 15px; font-size: 0.8em; font-weight: 600;">‚ùå Pas connect√©</span>
                            {% endif %}
                        </div>
                    </td>
                    <td style="padding: 15px; text-align: center; color: #718096; font-size: 0.9em;">{{ user.created_at.strftime('%d/%m/%Y') }}</td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="margin-bottom: 8px;">
                            {% if user.is_active %}
                            <button onclick="deactivateUser({{ user.id }})" style="background: #fc8181; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-right: 5px;">
                                üî¥ D√©sactiver
                            </button>
                            {% else %}
                            <button onclick="activateUser({{ user.id }})" style="background: #68d391; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-right: 5px;">
                                ‚úÖ Activer
                            </button>
                            {% endif %}
                        </div>
<div>
                            <!-- TEMPORAIRE: Comment√© en attendant la mise √† jour de la base
                            <button onclick="showApiKey({{ user.id }}, '{{ user.api_private_key if user.api_private_key else '' }}')" style="background: #4299e1; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-right: 5px;">
                                üîë Voir cl√© API
                            </button>
                            {% if not user.signum_connected %}
                            <button onclick="markSignumConnected({{ user.id }})" style="background: #9f7aea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                üîó Marquer connect√©
                            </button>
                            {% endif %}
                            -->
                            
                            <!-- Gardez juste les boutons de base pour l'instant -->
                            {% if user.is_active %}
                            <button onclick="deactivateUser({{ user.id }})" style="background: #fc8181; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                üî¥ D√©sactiver
                            </button>
                            {% else %}
                            <button onclick="activateUser({{ user.id }})" style="background: #68d391; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                ‚úÖ Activer
                            </button>
                            {% endif %}
                        </div>                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if not users %}
    <div style="text-align: center; padding: 60px 0; color: #718096;">
        <div style="font-size: 3em; margin-bottom: 20px;">üì≠</div>
        <h3>Aucun utilisateur inscrit</h3>
        <p>Les nouvelles inscriptions appara√Ætront ici.</p>
    </div>
    {% endif %}
</div>

<script>
async function activateUser(userId) {
    if (!confirm('√ätes-vous s√ªr de vouloir activer cet utilisateur ?')) return;
    
    try {
        const response = await fetch(`/admin/activate/${userId}`, {
            method: 'POST',
        });
        
        if (response.ok) {
            alert('‚úÖ Utilisateur activ√© avec succ√®s !');
            location.reload();
        } else {
            alert('‚ùå Erreur lors de l\'activation');
        }
    } catch (error) {
        alert('‚ùå Erreur de connexion');
    }
}

async function deactivateUser(userId) {
    if (!confirm('√ätes-vous s√ªr de vouloir d√©sactiver cet utilisateur ?')) return;
    
    try {
        const response = await fetch(`/admin/deactivate/${userId}`, {
            method: 'POST',
        });
        
        if (response.ok) {
            alert('üî¥ Utilisateur d√©sactiv√© avec succ√®s !');
            location.reload();
        } else {
            alert('‚ùå Erreur lors de la d√©sactivation');
        }
    } catch (error) {
        alert('‚ùå Erreur de connexion');
    }
}

function showApiKey(userId, apiKey) {
    // Cr√©er une modal pour afficher la cl√© API
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const content = document.createElement('div');
    content.style.cssText = `
        background: white; padding: 30px; border-radius: 15px;
        max-width: 600px; width: 90%;
    `;
    
    content.innerHTML = `
        <h2 style="margin-bottom: 20px; color: #2d3748;">üîë Cl√© API HyperLiquid</h2>
        <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-family: monospace; word-break: break-all; font-size: 14px;">
            ${apiKey}
        </div>
        <div style="text-align: center;">
            <button onclick="copyToClipboard('${apiKey}')" style="background: #4299e1; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px; font-size: 16px;">
                üìã Copier la cl√©
            </button>
            <button onclick="closeModal()" style="background: #e53e3e; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                ‚ùå Fermer
            </button>
        </div>
    `;
    
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    // Fermer en cliquant √† l'ext√©rieur
    modal.onclick = function(e) {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    };
    
    // Fonction pour fermer
    window.closeModal = function() {
        document.body.removeChild(modal);
    };
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        alert('üéâ Cl√© API copi√©e dans le presse-papiers !');
        closeModal();
    }).catch(function() {
        // Fallback pour anciens navigateurs
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('üéâ Cl√© API copi√©e !');
        closeModal();
    });
}

async function markSignumConnected(userId) {
    if (!confirm('Marquer ce client comme connect√© √† Signum ?')) return;
    
    try {
        const response = await fetch(`/admin/mark-signum-connected/${userId}`, {
            method: 'POST',
        });
        
        if (response.ok) {
            alert('üîó Client marqu√© comme connect√© √† Signum !');
            location.reload();
        } else {
            alert('‚ùå Erreur lors de la mise √† jour');
        }
    } catch (error) {
        alert('‚ùå Erreur de connexion');
    }
}
</script>
{% endblock %}

